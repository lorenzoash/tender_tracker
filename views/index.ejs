<!DOCTYPE html>
<html>

<head>
  <title>Tender Tracker</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
    crossorigin="anonymous">
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
    crossorigin="anonymous"></script>
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <script src="/app.js"></script>
</head>

<body>
  <div id="map">
  </div>

  <aside>
    <nav class="navbar navbar-inverse sidebar navbar-fixed-top" role="navigation">
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

      <div class="nav-side-menu">
        <div class="brand">Tender Traffic</div>
        <i class="fa fa-bars fa-2x toggle-btn" data-toggle="collapse" data-target="#menu-content"></i>

        <div class="menu-list">

          <ul id="menu-content" class="menu-content collapse out">


            <li data-toggle="collapse" data-target="#service" class="collapsed">
              <a href="#">
                <i class="fa fa-user fa-lg"></i> Profile
                <span class="arrow"></span>
              </a>
            </li>
            <ul class="sub-menu collapse" id="service">
              <ul class="right">
                <% if (user) { %>
                  <li>
                    <a href="/logout">
                      <i class="material-icons left"></i>Logout</a>
                  </li>
                  <% } else { %>
                    <li>
                      <a href="/auth/google">
                        <i class="material-icons left"></i>Login with Google</a>
                    </li>
                    <% } %>
              </ul>
            </ul>
            <li>
              <a href="#">
                <i class="fa fa-search fa-lg"></i> Search
              </a>
            </li>
            <% if (user) { %>
              <li data-toggle="collapse" data-target="#new" class="collapsed">
                <a href="#">
                  <i class="fa fa-heart fa-lg"></i> Favorites
                  <span class="arrow"></span>
                </a>
              </li>
              <ul class="sub-menu collapse" id="new">
                <li>New New 1</li>
                <li>New New 2</li>
                <li>New New 3</li>
              </ul>
              <% } %>
          </ul>
        </div>
      </div>

      <script>
        var contentString;
        function initMap() {
          let map = new google.maps.Map(document.getElementById('map'), {
            gestureHandling: 'greedy',
            mapTypeControl: false,
            zoomControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            scrollwheel: true,
            minZoom: 1.9,
            zoom: 2.2,
            center: { lat: 31.55143337748626, lng: -12.39556775341805 },
            styles: [
              {
                "elementType": "geometry",
                "stylers": [
                  {
                    "color": "#1d2c4d"
                  }
                ]
              },
              {
                "elementType": "labels.text.fill",
                "stylers": [
                  {
                    "color": "#8ec3b9"
                  }
                ]
              },
              {
                "elementType": "labels.text.stroke",
                "stylers": [
                  {
                    "color": "#0f330c"
                  }
                ]
              },
              {
                "featureType": "administrative",
                "elementType": "geometry",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "administrative.country",
                "elementType": "geometry.stroke",
                "stylers": [
                  {
                    "color": "#4b6878"
                  }
                ]
              },
              {
                "featureType": "administrative.land_parcel",
                "elementType": "labels.text",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "administrative.land_parcel",
                "elementType": "labels.text.fill",
                "stylers": [
                  {
                    "color": "#64779e"
                  },
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "administrative.locality",
                "elementType": "labels",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "administrative.neighborhood",
                "elementType": "labels.text",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "administrative.province",
                "elementType": "labels",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "landscape.man_made",
                "elementType": "labels.text",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "landscape.natural",
                "elementType": "geometry",
                "stylers": [
                  {
                    "color": "#023e58"
                  }
                ]
              },
              {
                "featureType": "landscape.natural",
                "elementType": "labels.text",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "poi",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "road",
                "elementType": "labels.icon",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "transit",
                "stylers": [
                  {
                    "visibility": "off"
                  }
                ]
              },
              {
                "featureType": "water",
                "elementType": "geometry",
                "stylers": [
                  {
                    "color": "#0e1626"
                  }
                ]
              },
              {
                "featureType": "water",
                "elementType": "labels.text.fill",
                "stylers": [
                  {
                    "color": "#2594f3"
                  }
                ]
              }
            ]

          });

          google.maps.event.addListener(map, 'drag', function () {

            var proj = map.getProjection();
            var bounds = map.getBounds();
            var sLat = map.getBounds().getSouthWest().lat();
            var nLat = map.getBounds().getNorthEast().lat();
            if (sLat < -85 || nLat > 85) {
              // alert('Gray area visible');
              map.setOptions({
                center: new google.maps.LatLng(
                  31.55143337748626, // set Latitude for center of map here
                  -12.39556775341805) // set Langitude for center of map here
              });
              // map.fitBounds(boundsNew);  Or Define bound that u want show
            }
          });

          const rootURL = 'https://secure.geonames.org/countryCodeJSON?';

        <% if (user) { %>
            function getCC(lat, lng) {
              return fetch(`${rootURL}lat=${lat}&lng=${lng}&username=<%= process.env.GEO_USENAME %>`)
                .then(cCode => cCode.json())
                .then(cCode => cCode.countryCode)
                .then(function (cCode) {
                  return fetch('/sites/topTen', {
                    method: 'post',
                    body: JSON.stringify({
                      countryCode: cCode
                    }),
                    headers: {
                      "Content-Type": "application/json",
                      "Access-Control-Allow-Origin": "*"
                    },
                    credentials: 'include'
                  })
                    .then(countryData => countryData.json())
                    .then(function (countryData) {
                      console.dir(countryData);

                      let countryTopSites = "";
                      countryData.topSites.country.sites.site.forEach(function (country) {

                        countryTopSites += `<tr>
                          <td><a href="http://www.${country.dataUrl}"target="_blank">${country.dataUrl}</a></td>
                          </tr>`;

                        contentString = `
                        <div id="content">
                          <div id="siteNotice"> 
                            <h3 id="firstHeading" class="firstHeading">${countryData.topSites.country.countryName}</h3>
                            <button onclick= "addFavorties(${countryData.topSites.country.countryCode}, ${countryData.topSites.country.countryName})" class="fa fa-heart fa-lg text-muted" data-toggle="button" style="text-decoration: none"></button>
                            
                            <div id="bodyContent">
                              <table class="table table-dark table-hover mb-0 ">
                                <thead class="thead-light">
                                  <tr>
                                    <th scope="col"> # </th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Rank</th>
                                    <th scope="col">Profile Page</th>
                                  </tr>
                                </thead>
                              ${countryTopSites}
                              </table>
                            </div>
                          </div>
                        </div>
                        `;
                      })
                    })
                    .catch(err => `Err is: ${err}`);
                })
            }

            google.maps.event.addListener(map, 'click', function (event) {

              marker = new google.maps.Marker({
                position: event.latLng,
                map: map,
                animation: google.maps.Animation.DROP
              });

              let lat = event.latLng.lat();
              let lng = event.latLng.lng();

              getCC(lat, lng).then(function () {
                console.log(contentString);
                let infowindow = new google.maps.InfoWindow({
                  content: contentString
                });
                infowindow.open(map, marker);
                google.maps.event.addListener(marker, 'click', function () {

                  infowindow.open(map, marker) ? "" : infowindow.open(map, marker);
                });
                // google.maps.event.addListener(infowindow, 'closeclick', function () {
                //   setMapOnAll(null);; //removes the marker
                //   // then, remove the infowindows name from the array
                // });
              });



              // console.log(event.latLng.lat())
              // console.log(event.latLng.lng())
            });
              
            <% } %>

          }
      </script>
      <div class="main">
      </div>
      </div>
    </nav>

  </aside>

</body>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= process.env.GOOGLE_MAP_KEY %>&callback=initMap"></script>

</html>